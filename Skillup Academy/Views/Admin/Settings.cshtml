@using Skillup_Academy.ViewModels.AdminDashboard
@model AdminSettingViewModel

@{
    ViewData["Title"] = "Admin Profile Settings";
    string profPicInputId = "NewProfilePicInput";
    string profPicPreviewId = "ProfilePicPreviewNew";
    var baseMediaPath = "/img/";
    var currentProfilePath = string.IsNullOrEmpty(Model.CurrentProfilePicturePath) ? "N/A" : Model.CurrentProfilePicturePath;
    if (currentProfilePath != "N/A" && !currentProfilePath.StartsWith(baseMediaPath))
    {
        currentProfilePath = baseMediaPath + currentProfilePath.Replace("~", "");
    }
}


<div class="container-fluid mt-4">
    <div class="row">

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-body text-center">

                    <div class="profile-area mb-3">
                        <img class="img-profile rounded-circle mb-3"
                             @* src="@(Model.CurrentProfilePicturePath ?? "/img/default_admin.svg")" *@
                             src="@currentProfilePath"
                             alt="Profile Image"
                             style="width: 150px; height: 150px; object-fit: cover;">

                        <h5 class="font-weight-bold">@Model.FullName</h5>
                        <span class="badge badge-primary">Admin</span>
                    </div>

                    <hr class="sidebar-divider">

                    <h6 class="text-left font-weight-bold mb-3">Quick Actions</h6>

                    <button class="btn btn-primary btn-block mb-2" data-toggle="modal" data-target="#editProfileModal">
                        <i class="fas fa-edit mr-2"></i> Edit Profile
                    </button>

                    @* <button class="btn btn-warning btn-block mb-2 text-white" data-toggle="modal" data-target="#changePasswordModal">
                        <i class="fas fa-lock mr-2"></i> Change Password
                    </button> *@
                    <a asp-controller="Admin" asp-action="ChangePassword" class="btn btn-warning btn-block mb-2 text-white">
                        <i class="fas fa-lock mr-2"></i> Change Password
                    </a>

                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Account Information</h6>
                </div>
                <div class="card-body">

                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted font-weight-bold">Full Name</div>
                        <div class="col-sm-8">@Model.FullName</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted font-weight-bold">Email</div>
                        <div class="col-sm-8">@Model.Email</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted font-weight-bold">Phone Number</div>
                        <div class="col-sm-8">@Model.PhoneNumber</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted font-weight-bold">Account Created</div>
                        <div class="col-sm-8">@Model.RegistrationDate</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted font-weight-bold">Last Updated</div>
                        <div class="col-sm-8">@Model.LastProfileUpdate</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Edit Profile Information</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form asp-controller="Admin" asp-action="Settings" method="post" enctype="multipart/form-data">
                <div class="modal-body">

                    <div class="form-group">
                        <label asp-for="FullName"></label>
                        <input asp-for="FullName" class="form-control" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Email"></label>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="PhoneNumber"></label>
                        <input asp-for="PhoneNumber" class="form-control" />
                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                    </div>

                    @* <div class="form-group">
                        <label asp-for="ProfilePicture"></label>
                        <div class="custom-file">
                            <input asp-for="ProfilePicture" class="custom-file-input" id="profileImageInput" />
                            <label class="custom-file-label" for="profileImageInput">Choose file...</label>
                        </div>
                        <span asp-validation-for="ProfilePicture" class="text-danger"></span>
                    </div> *@
                    <div class="form-group">
                        <label class="form-label fw-bold d-block text-dark">
                            <i class="fas fa-image me-2"></i> Profile Picture
                        </label>

                        <div id="current-profile-display" class="mb-3 p-2 border rounded text-center bg-white" style="min-height: 180px;">
                            <h6 class="text-muted small border-bottom pb-1 mb-2">Currently Saved Picture</h6>
                            @if (currentProfilePath != "N/A")
                            {
                                <img src="@currentProfilePath" alt="Current Profile Picture" class="img-fluid rounded-circle mb-2" style="max-height: 100px; max-width: 100px; object-fit: cover;">
                                <p class="text-muted small mb-0">Saved: **@(Model.CurrentProfilePicturePath ?? "N/A")**</p>
                            }
                            else
                            {
                                <p class="text-muted small mt-2 mb-0 py-3">No Current Picture Set.</p>
                            }
                            <a href="javascript:void(0)" onclick="toggleMediaInput('profile', '@profPicInputId', 'current-profile-display')" class="btn btn-sm btn-outline-primary mt-2">
                                Change Picture
                            </a>
                        </div>

                        <div id="profile-new-input-container" class="mt-3 p-3 border rounded shadow-sm bg-white" style="display: none;">
                            <h6 class="text-info fw-bold">Upload New Picture</h6>
                            <input type="file" asp-for="ProfilePicture" id="@profPicInputId" class="form-control" accept="image/*" onchange="previewFile('@profPicInputId', '@profPicPreviewId', 'image')" />
                            <span asp-validation-for="ProfilePicture" class="text-danger small"></span>

                            <div class="mt-2 p-2 border rounded text-center bg-light">
                                <img id="@profPicPreviewId" src="#" alt="New Image Preview" class="img-fluid rounded-circle" style="display: none; max-height: 100px; max-width: 100px; object-fit: cover; margin: auto;" />
                                <p id="@(profPicPreviewId + "Placeholder")" class="text-muted mb-0 py-1"><i class="fas fa-image fs-4"></i> New Preview</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@* @await Html.PartialAsync("_ChangePasswordModal", new ChangePasswordViewModel()) *@

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function toggleMediaInput(type, inputId, currentDisplayId) {
                    const inputContainer = document.getElementById(type + '-new-input-container');
                    const currentDisplay = document.getElementById(currentDisplayId);

                    if (inputContainer.style.display === 'none') {
                        inputContainer.style.display = 'block';
                        currentDisplay.style.display = 'none';
                        document.getElementById(inputId).focus();
                    } else {
                        inputContainer.style.display = 'none';
                        currentDisplay.style.display = 'block';
                    }
                }

                function previewFile(inputId, previewId, fileType) {
                    const input = document.getElementById(inputId);
                    const previewElement = document.getElementById(previewId);
                    const placeholder = document.getElementById(previewId + "Placeholder");

                    previewElement.style.display = 'none';
                    placeholder.style.display = 'block';
                    previewElement.removeAttribute('src');

                    if (input.files && input.files[0]) {
                        const reader = new FileReader();

                        reader.onload = function(e) {
                            if (fileType === 'image') {
                                previewElement.setAttribute('src', e.target.result);
                            }

                            previewElement.style.display = 'block';
                            placeholder.style.display = 'none';
                        };

                        reader.readAsDataURL(input.files[0]);
                    }
                }

            $(document).ready(function () {

            var errorsExist = '@TempData["PasswordChangeFailed"]' === 'True';

            if (errorsExist) {
                $('#changePasswordModal').modal('show');
            }
        });
    </script>
}